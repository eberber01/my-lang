name: RISCV-32 Linux Compiler CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  BUILD_TYPE: Release
  RISCV_PREFIX: riscv32-linux-gnu

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: eberber01/riscv32-compiler-ci:latest

    steps:
      - uses: actions/checkout@v4

      - name: Verify toolchain
        run: |
          which ${RISCV_PREFIX}-gcc
          ${RISCV_PREFIX}-gcc --version
          qemu-riscv32 --version

      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -DRV32=1 \
            -DRISCV_AS=$(which ${RISCV_PREFIX}-as) \
            -DRISCV_LD=$(which ${RISCV_PREFIX}-ld)

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Runtime tests
        run: cmake --build build --target runtime_tests


